{"hash":"991b478cce50973ae5c1821e372bff0fe0c029c3","data":{"tag":{"title":"Solr","belongsTo":{"edges":[{"node":{"title":"Install Solr 5 and Zookeeper in a production environment","path":"/install-solr-5-and-zookeeper-in-a-production-environment/","date":"4. June 2015","timeToRead":6,"description":"Recently I had to set up three Solr servers in an AWS environment. I couldn’t find anything specific to help me, so had to locate all the information separately. Hopefully the following may be of use to anyone who has to go through the same. In my situation, I have 3 servers that will sit behind a load balancer. The following describes how I set up each server.","content":"<p>Recently I had to set up three Solr servers in an AWS environment. I couldn’t find anything specific to help me, so had to locate all the information separately. Hopefully the following may be of use to anyone who has to go through the same. In my situation, I have 3 servers that will sit behind a load balancer. The following describes how I set up each server.</p>\n<p>Initially I thought it best to update all packages on each Amazon Linux AMI. I was using a green field environment. You might not be in that situation, so may not want to do the following.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo yum clean all\nsudo yum update</code></pre>\n<p>Solr 5 requires a newer version of Java that was pre-installed on the server. So we need to obtained an updated Java package, and select it as the default version.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo yum install java-1.7.0-openjdk\nsudo alternatives --config java</code></pre>\n<p>Now we need to obtain a Solr package. You can find a mirror here: <a href=\"http://lucene.apache.org/solr/mirrors-solr-latest-redir.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://lucene.apache.org/solr/mirrors-solr-latest-redir.html</a>. For example, I downloaded an archive using:</p>\n<pre class=\"language-text\"><code class=\"language-text\">wget http://mirror.catn.com/pub/apache/lucene/solr/5.1.0/solr-5.1.0.tgz</code></pre>\n<p>Let’s make certain all the pre-requisites exist to run Solr, but decompressing the archive, and running it.</p>\n<pre class=\"language-text\"><code class=\"language-text\">tar zxf solr-5.1.0.tgz\ncd solr-5.1.0\nbin/solr start\nbin/solr status</code></pre>\n<p>If Solr looks like it is running correctly, let’s stop it.</p>\n<pre class=\"language-text\"><code class=\"language-text\">bin/solr stop</code></pre>\n<p>We can now install it using the pre-packaged service install script that comes with the archive. Exit the Solr folder, and extract the service install script.</p>\n<pre class=\"language-text\"><code class=\"language-text\">cd ..\ntar xzf solr-5.1.0.tgz solr-5.1.0/bin/install_solr_service.sh --strip-components=2</code></pre>\n<p>Using this script we can install the service.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo bash ./install_solr_service.sh solr-5.1.0.tgz</code></pre>\n<p>The script will install Solr into /opt/solr-5.1.0, with a symbolic link from /opt/solr. All writable files (i.e. logs) are placed in /opt/solr. The service runs under the user ‘solr’, that will be created for this purpose. Check the service is running correctly.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo service solr status</code></pre>\n<p>Just to note, by default the Java heap size is 512M. This will more than likely need to be increased in a production environment. What this value will be will depend on your requirements, and is beyond the scope of this post. If you do need to amend this value, use an editor such as Vi to edit the following file:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo vi /var/solr/solr.in.sh</code></pre>\n<p>The specific value you will need to change is SOLR_JAVA_MEM. Restart the service to make certain the new configuration is picked up.</p>\n<p>You should now be able to access the Solr admin site on the server. By default this runs on port 8983, for example:</p>\n<p><a href=\"http://your-server:8983/solr/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://your-server:8983/solr/</a></p>\n<p>Now Solr is up and running we need to set up Zookeeper. Zookeeper is used to maintain the configuration between the three Solr servers.</p>\n<p>Once again we need to obtain a package from a Zookeeper mirror.</p>\n<pre class=\"language-text\"><code class=\"language-text\">get http://mirror.vorboss.net/apache/zookeeper/current/zookeeper-3.4.6.tar.gz</code></pre>\n<p>Zookeeper does not come with a nice service installer, so we need to manually set this up. First extract into /opt.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo tar xzxf zookeeper-3.4.6.tar.gz -C /opt</code></pre>\n<p>Create a symbolic link. This is for ease of upgrading.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo ln -s /opt/zookeeper-3.4.6/ /opt/zookeeper</code></pre>\n<p>Rename the example Zookeeper config file.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo mv /opt/zookeeper/conf/zoo_sample.cfg /opt/zookeeper/conf/zoo.cfg</code></pre>\n<p>You will need to add something like the following to zoo.cfg. These lines list all servers that need to be maintained by Zookeeper. Amend with applicable server IP addresses.</p>\n<pre class=\"language-text\"><code class=\"language-text\">server.1=serverip1:2888:3888\nserver.2=serverip2:2888:3888\nserver.3=serverip3:2888:3888</code></pre>\n<p>Whilst editing this file, change the data directory:</p>\n<pre class=\"language-text\"><code class=\"language-text\">dataDir=/var/lib/zookeeper/data</code></pre>\n<p>Each server requires a context file called ‘myid’. This is used to identify it.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo mkdir /var/lib/zookeeper\nsudo mkdir /var/lib/zookeeper/data\nsudo touch /var/lib/zookeeper/data/myid</code></pre>\n<p>Edit each myid file and add the appropriate number for each server. For example, for three servers this will be 1, 2 or 3.</p>\n<p>Now start up each ZooKeeper server:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo /opt/zookeeper/bin/zkServer.sh start</code></pre>\n<p>We need to return to Solr, to configure the Zookeeper hosts. Edit the solr.xml file::</p>\n<p>sudo vi /var/solr/data/solr.xml</p>\n<p>Within the solrcloud element add the following, once again amending with your server IP addresses:</p>\n<pre class=\"language-text\"><code class=\"language-text\">serverip1:2181,serverip2:2182,serverip3:2183</code></pre>\n<p>It should look something like the following:</p>\n<pre class=\"language-text\"><code class=\"language-text\">&lt;solr&gt;\n  &lt;solrcloud&gt;\n    ...\n    &lt;str name=&quot;zkHost&quot;&gt;serverip1:2181,serverip2:2182,serverip3:2183&lt;/str&gt;\n  &lt;/solrcloud&gt;\n&lt;/solr&gt;</code></pre>\n<p>Restart Solr on all servers managed by Zookeeper:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo service solr restart</code></pre>\n<p>We can check Solr is connected to Zookeeper, by obtaining its status.</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo service solr status</code></pre>\n<p>There should be some additional JSON in the response returned:</p>\n<pre class=\"language-text\"><code class=\"language-text\">&quot;cloud&quot;:{\n    &quot;ZooKeeper&quot;:&quot;serverip1:2181,serverip2:2182,serverip3:2183&quot;,\n    &quot;liveNodes&quot;:&quot;3&quot;,\n    &quot;collections&quot;:&quot;0&amp;&quot;\n}</code></pre>\n<p>Now everything is working correct, we should create a start up script for Zookeeper. We are going to customise the zkServer.sh script. First copy to the start up scripts:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo cp /opt/zookeeper/bin/zkServer.sh /etc/init.d/zookeeper</code></pre>\n<p>Edit the copied file to include the following start up comment:</p>\n<pre class=\"language-text\"><code class=\"language-text\"># chkconfig: - 20 80\n# description: starts zookeeper - /opt/zookeeper under user root</code></pre>\n<p>I also amended the path to the bin directory. Locate and edit the following in the script:</p>\n<pre class=\"language-text\"><code class=\"language-text\">ZOOBIN=/opt/zookeeper/bin</code></pre>\n<p>Now we can add the start up script, and switch it on:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo chkconfig --add /etc/init.d/zookeeper\nsudo chkconfig --level 2345 zookeeper on</code></pre>\n<p>These will give it the same start options as Solr.</p>\n<p>This should have Solr, and Zookeeper set up and installed on all three servers. You may have more servers if your requirements are more extensive. Bear in mind, Zookeeper requires an odd number of servers to function.</p>\n<p>As an addition to the post, we can now add a collection, and test that it is replicated across our Solr servers. I copied collection configuration from our development environment into the home directory of the user I managed the Solr servers with. I could then use this configuration to create my new collection.</p>\n<p>So to create a new collection, reference the uploaded collection configuration, so that it is stored in Zookeeper:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo /opt/solr/bin/solr create_collection -c collection-qa -d ~/collection-dev/conf -n collection-qa -shards 1 -replicationFactor 3</code></pre>\n<p>This created a collection called ‘collection-qa’, from the configuration I had uploaded into the ~/collection-dev/conf folder. For my purposes a wanted one shard, replicated over all three Solr servers.</p>\n<p>If you need to remove a collection use can use the following:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo /opt/solr/bin/solr delete -c collection-qa</code></pre>\n<p>All collection configuration files are now in Zookeeper. If you want to update this configuration, and not delete the how collection, you’ll need to use the Solr version of the Zookeeper CLI. It can be sound here:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo /opt/solr/server/scripts/cloud-scripts/zkcli.sh</code></pre>\n<p>For example, to view the collection schema stored in Zookeeper, use:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo /opt/solr/server/scripts/cloud-scripts/zkcli.sh -zkhost localhost:2181 -cmd get /configs/collection-qa/schema.xml</code></pre>\n<p>To upload an amended schema file to Zookeeper use:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo /opt/solr/server/scripts/cloud-scripts/zkcli.sh -zkhost localhost:2181 -cmd putfile /configs/collection-qa/schema.xml collection-dev/conf/schema.xml</code></pre>\n<p>I’ve used the example file names, and locations as explained previously. You’ll need to amend for your purposes.</p>\n<p>If you do update the document schema you will need to reload a core using something like Curl to do the following:</p>\n<pre class=\"language-text\"><code class=\"language-text\">sudo curl http://localhost:8983/solr/admin/cores?action=RELOAD\\&amp;amp;amp;amp;amp;amp;amp;core=collection-qa_shard1_replica3</code></pre>\n<p>I hope this has been useful, but appreciate that I might not be too clear on some instructions. If you need me to clarify anything, give us a shout.</p>\n"}}]}}},"context":{}}