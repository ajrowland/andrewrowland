{"hash":"991b478cce50973ae5c1821e372bff0fe0c029c3","data":{"post":{"title":"Using the Zend framework Lucene library Part 2","path":"/using-the-zend-framework-lucene-library-part-2/","date":"4. July 2008","timeToRead":3,"tags":[{"id":"CodeIgniter","title":"CodeIgniter","path":"/tag/CodeIgniter/"},{"id":"PHP","title":"PHP","path":"/tag/PHP/"}],"description":"Note: Since this article was written I’ve moved to WordPress, and have not implemented the example code listed below.\nIn a previous article I talked about using a library from the Zend framework to create a site search. As you try out this functionality using the search box, above right.","content":"<p><strong>Note</strong>: Since this article was written I’ve moved to WordPress, and have not implemented the example code listed below.</p>\n<p>In a previous article I talked about using a library from the Zend framework to create a site search. As you try out this functionality using the search box, above right.</p>\n<p>I never finished the article, so I'll explain here how I implemented this using CodeIgniter. I'll also detail how I built the 'quick results' tool (click in the search box).</p>\n<p>Below is an example controller class that shows how I constructed the search index by pulling articles out of the database. My actual class calls security methods that require authentication before performing any of these methods. I left them out of the listing to keep it short and sweet. You will have to alter the code to allow for the difference in database schema, and to suit your intended available search criteria.</p>\n<pre class=\"language-text\"><code class=\"language-text\">&lt;?php\nclass Search extends Controller {\n\n    function Search()\n    {\n        parent::Controller();\n\n        // Load Zend Lucene library.  See previous article.\n        $this-&gt;load-&gt;library(&#39;zend&#39;);\n        $this-&gt;zend-&gt;load( &#39;Zend/Search/Lucene&#39;);\n\n        // Location of search index.  Used by all Search controller methods.\n        $this-&gt;search_index = APPPATH . &#39;search/index&#39;;\n    }\n\n    function reindex()\n    {\n        // Create index.  Will delete any existing index.\n        $index = Zend_Search_Lucene::create($this-&gt;search_index);\n\n        // Obtain all articles.\n        $query = $this-&gt;db-&gt;get(&#39;articles&#39;);\n\n        // Loop through articles, adding an index for each one.\t\t\n        foreach ($query-&gt;result() as $article)\n        {\n            // Create Lucene document for this article.\n            $doc = new Zend_Search_Lucene_Document();\n\n            // Add required fields.\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;title&#39;, $article-&gt;title));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;subtitle&#39;, $subtitle));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;category&#39;, $category_list));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;path&#39;, &#39;/article/display/&#39; . $article-&gt;path));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::UnStored(&#39;content&#39;, $article-&gt;summary . $article-&gt;text));\n\n            // Add docuument to index.\n            $index-&gt;addDocument($doc);\n\n            echo &#39;Added &#39; . $item-&gt;title . &#39; to index.&lt;br /&gt;&#39;;\n        }\n\n        $index-&gt;optimize();\n    }\n\n    function optimize()\n    {\n        $index = Zend_Search_Lucene::open($this-&gt;search_index);\n        $index-&gt;optimize();\n\n        echo &#39;&lt;p&gt;Index optimized.&lt;/p&gt;&#39;;\n    }\n}</code></pre>\n<p>To utilise the index a result method is required:</p>\n<pre class=\"language-text\"><code class=\"language-text\">function result()\n{\n    // Create empty array, in case there are no results.\n    $data[&#39;results&#39;] = array();\n\n    // If a search_query parameter has been posted, search the index.\n    if ($this-&gt;input-&gt;post(&#39;search_query&#39;))\n    {\n        $index = Zend_Search_Lucene::open($this-&gt;search_index);\n\n        // Get results.\n        $data[&#39;results&#39;] = $index-&gt;find($this-&gt;input-&gt;post(&#39;search_query&#39;));\n    }\n\n    // Load view, and populate with results.\n    $this-&gt;load-&gt;view(&#39;search_result_view&#39;, $data);\n}</code></pre>\n<p>And, of course, a view is required to display the results:</p>\n<pre class=\"language-text\"><code class=\"language-text\">&lt;html&gt;\n&lt;head&gt;\n    &lt;title&gt;Search results&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\t\t\n\n&lt;h1&gt;Search results&lt;/h1&gt;\n\n&lt;?php if (empty($_POST[&#39;search_query&#39;])):?&gt;\n&lt;p&gt;No search query submitted.&lt;/p&gt;\n&lt;?php else:?&gt;\n    &lt;?php if (count($results)):?&gt;\n&lt;p&gt;&lt;?php echo count($results) ?&gt; result(s) returned for query: &lt;?php echo $_POST[&#39;search_query&#39;];?&gt;&lt;/p&gt;\n&lt;ul&gt;\n    &lt;?php foreach($results as $result):?&gt;\n    &lt;li&gt;&lt;?=anchor(site_url($result-&gt;path), $result-&gt;title);?&gt; (&lt;?php echo round($result-&gt;score, 2) * 100;?&gt;%)&lt;/li&gt;\n    &lt;?php endforeach;?&gt;\n&lt;/ul&gt;\n    &lt;?php else:?&gt;\n&lt;p&gt;No results were returned for query: &lt;?php echo $_POST[&#39;search_query&#39;];?&gt;&lt;/p&gt;\n    &lt;?php endif;?&gt;\n&lt;?php endif;?&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;</code></pre>\n","cover_image":null,"comments":[]}},"context":{}}