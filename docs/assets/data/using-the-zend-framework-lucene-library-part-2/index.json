{"hash":"5b49c3fca0ea19b2d658cac8ea59d3ee4db08fd8","data":{"post":{"title":"Using the Zend framework Lucene library Part 2","path":"/using-the-zend-framework-lucene-library-part-2/","date":"4. July 2008","timeToRead":10,"tags":[{"id":"CodeIgniter","title":"CodeIgniter","path":"/tag/CodeIgniter/"},{"id":"PHP","title":"PHP","path":"/tag/PHP/"}],"description":"Note: Since this article was written I’ve moved to WordPress, and have not implemented the example code listed below.\nIn a previous article I talked about using a library from the Zend framework to create a site search. As you try out this functionality using the search box, above right.","content":"<p><strong>Note</strong>: Since this article was written I’ve moved to WordPress, and have not implemented the example code listed below.</p>\n<p>In a previous article I talked about using a library from the Zend framework to create a site search. As you try out this functionality using the search box, above right.</p>\n<p>I never finished the article, so I'll explain here how I implemented this using CodeIgniter. I'll also detail how I built the 'quick results' tool (click in the search box).</p>\n<p>Below is an example controller class that shows how I constructed the search index by pulling articles out of the database. My actual class calls security methods that require authentication before performing any of these methods. I left them out of the listing to keep it short and sweet. You will have to alter the code to allow for the difference in database schema, and to suit your intended available search criteria.</p>\n<pre class=\"language-text\"><code class=\"language-text\">&lt;?php\nclass Search extends Controller {\n\n    function Search()\n    {\n        parent::Controller();\n\n        // Load Zend Lucene library.  See previous article.\n        $this-&gt;load-&gt;library(&#39;zend&#39;);\n        $this-&gt;zend-&gt;load( &#39;Zend/Search/Lucene&#39;);\n\n        // Location of search index.  Used by all Search controller methods.\n        $this-&gt;search_index = APPPATH . &#39;search/index&#39;;\n    }\n\n    function reindex()\n    {\n        // Create index.  Will delete any existing index.\n        $index = Zend_Search_Lucene::create($this-&gt;search_index);\n\n        // Obtain all articles.\n        $query = $this-&gt;db-&gt;get(&#39;articles&#39;);\n\n        // Loop through articles, adding an index for each one.\n        foreach ($query-&gt;result() as $article)\n        {\n            // Create Lucene document for this article.\n            $doc = new Zend_Search_Lucene_Document();\n\n            // Add required fields.\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;title&#39;, $article-&gt;title));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;subtitle&#39;, $subtitle));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;category&#39;, $category_list));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::Text(&#39;path&#39;, &#39;/article/display/&#39; . $article-&gt;path));\n            $doc-&gt;addField(Zend_Search_Lucene_Field::UnStored(&#39;content&#39;, $article-&gt;summary . $article-&gt;text));\n\n            // Add docuument to index.\n            $index-&gt;addDocument($doc);\n\n            echo &#39;Added &#39; . $item-&gt;title . &#39; to index.&lt;br /&gt;&#39;;\n        }\n\n        $index-&gt;optimize();\n    }\n\n    function optimize()\n    {\n        $index = Zend_Search_Lucene::open($this-&gt;search_index);\n        $index-&gt;optimize();\n\n        echo &#39;&lt;p&gt;Index optimized.&lt;/p&gt;&#39;;\n    }\n}</code></pre>\n<p>To utilise the index a result method is required:</p>\n<pre class=\"language-text\"><code class=\"language-text\">function result()\n{\n    // Create empty array, in case there are no results.\n    $data[&#39;results&#39;] = array();\n\n    // If a search_query parameter has been posted, search the index.\n    if ($this-&gt;input-&gt;post(&#39;search_query&#39;))\n    {\n        $index = Zend_Search_Lucene::open($this-&gt;search_index);\n\n        // Get results.\n        $data[&#39;results&#39;] = $index-&gt;find($this-&gt;input-&gt;post(&#39;search_query&#39;));\n    }\n\n    // Load view, and populate with results.\n    $this-&gt;load-&gt;view(&#39;search_result_view&#39;, $data);\n}</code></pre>\n<p>And, of course, a view is required to display the results:</p>\n<pre class=\"language-text\"><code class=\"language-text\">&lt;html&gt;\n&lt;head&gt;\n    &lt;title&gt;Search results&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n\n&lt;h1&gt;Search results&lt;/h1&gt;\n\n&lt;?php if (empty($_POST[&#39;search_query&#39;])):?&gt;\n&lt;p&gt;No search query submitted.&lt;/p&gt;\n&lt;?php else:?&gt;\n    &lt;?php if (count($results)):?&gt;\n&lt;p&gt;&lt;?php echo count($results) ?&gt; result(s) returned for query: &lt;?php echo $_POST[&#39;search_query&#39;];?&gt;&lt;/p&gt;\n&lt;ul&gt;\n    &lt;?php foreach($results as $result):?&gt;\n    &lt;li&gt;&lt;?=anchor(site_url($result-&gt;path), $result-&gt;title);?&gt; (&lt;?php echo round($result-&gt;score, 2) * 100;?&gt;%)&lt;/li&gt;\n    &lt;?php endforeach;?&gt;\n&lt;/ul&gt;\n    &lt;?php else:?&gt;\n&lt;p&gt;No results were returned for query: &lt;?php echo $_POST[&#39;search_query&#39;];?&gt;&lt;/p&gt;\n    &lt;?php endif;?&gt;\n&lt;?php endif;?&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;</code></pre>\n<h2 id=\"20-thoughts-on-using-the-zend-framework-lucene-library-part-2\"><a href=\"#20-thoughts-on-using-the-zend-framework-lucene-library-part-2\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>20 thoughts on “Using the Zend framework Lucene library Part 2”</h2>\n<h3 id=\"jeff\"><a href=\"#jeff\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Jeff</h3>\n<p><em>November 14, 2008 at 8:07 am</em></p>\n<p>Great post! Keep it up.</p>\n<hr>\n<h3 id=\"rob\"><a href=\"#rob\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Rob</h3>\n<p><em>March 9, 2009 at 6:01 am</em></p>\n<p>Hi Andrew,</p>\n<p>Many thanks for these articles, after a little tweakage I managed to get it all going on a project I’m working on. (I’m pretty new to CI/PHP/Apache having come from ASP/VBScript/IIS [Yuk, I know..])</p>\n<p>However, I have a question: At the moment, same as your tutorial, I’m searching on only one table in the db, a table called Items (news, events, careers) which is fine but I need to be able to index a number of other tables. What I’m mostly wondering about is how to set the link in the result, I presume the rest is just replicating the code I already have for indexing?</p>\n<p>Have you any insights, experience, wisdom, links? Any help would be greatly appreciated.</p>\n<p>Thanks,</p>\n<p>Rob.</p>\n<hr>\n<h3 id=\"rob-1\"><a href=\"#rob-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Rob</h3>\n<p><em>March 11, 2009 at 5:35 am</em></p>\n<p>Andrew,</p>\n<p>Many thanks for your swift and insightful reply.. I haven’t had a chance to test it yet but your code and explanations make sense and have cleared up a lot for me.</p>\n<p>Thanks again for your time, you’ve saved me a lot of mine!</p>\n<p>Cheers!</p>\n<p>Rob.</p>\n<hr>\n<h3 id=\"zaw\"><a href=\"#zaw\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>zaw</h3>\n<p><em>March 13, 2009 at 9:42 am</em></p>\n<p>In the display result view page, when searching html file content the result will be long text.\nHow can I display only the synopsis of the long text?\nI want to show the parts of text in result that found the search terms.</p>\n<p>e.g. in google result when I find the search term | zend framework sample |</p>\n<p>Akra?s DevNotes ? Tutorial: Getting Started with Zend Framework\nThe original tutorial for Zend Framework 1.0 is still available, ... Rob, Did you have a sample of using Zend call linux command ? how to do that? ...</p>\n<p>In above e.g., Google show two parts of text. How can I do like this?</p>\n<hr>\n<h3 id=\"zaw-1\"><a href=\"#zaw-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>zaw</h3>\n<p><em>March 14, 2009 at 3:28 pm</em></p>\n<p>Hi Andrew</p>\n<p>I mean in the result list I would like to show only the line near the search term found.</p>\n<p>I’m testing with zend frame sample code ZendFramework-1.7.6demosZendSearchLucenefeed-searchsearch-index.php</p>\n<p>At line 41 of search-index.php, trim(substr($hit->$field,0,76)). It is only show the first 76 characters of result text.</p>\n<p>I’m afraid that the search term may not include within first 76 characters.\nI mean if the search term found at the postition of 100th character, I want to show the text near 100th character like google result.</p>\n<p>thanks</p>\n<hr>\n<h3 id=\"andy\"><a href=\"#andy\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Andy</h3>\n<p><em>March 15, 2009 at 12:52 pm</em></p>\n<p>Hello Zaw</p>\n<p>Take a look at:</p>\n<p><a href=\"http://framework.zend.com/manual/en/zend.search.lucene.searching.html#\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://framework.zend.com/manual/en/zend.search.lucene.searching.html#</a>\nzend.search.lucene.searching.highlighting</p>\n<p>You will need to store the content as a text field, so it can be used by the Zend Query Parser to highlight the returned text.</p>\n<p>The main problem you will have, is restricting the amount of content returned, as you will not want the entire document, only the sentence(s) in which the highlighed search terms appear.</p>\n<p>I had a go quick on my site, and made it work, but did not get around to the final problem I’ve, er, highlighed.</p>\n<hr>\n<h3 id=\"zaw-2\"><a href=\"#zaw-2\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Zaw</h3>\n<p><em>May 13, 2009 at 4:38 am</em></p>\n<p>Hello</p>\n<p>Thanks for your reply.</p>\n<p>I found a way to display search results as I want in the following link\n<a href=\"http://www.whatstyle.net/articles/6/displaying_search_results_with_php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://www.whatstyle.net/articles/6/displaying_search_results_with_php</a></p>\n<p>This class can show the parts of content near search keyword.\nI want to integrate this class with zend lucene result.\nBut this chunk class require three parameters</p>\n<ol>\n<li>the subject string,</li>\n<li>a maximum amount of characters and</li>\n<li>an array of search words.</li>\n</ol>\n<p>How can I get array of search words from zend lucene result?\nIf I query with wild card in lucene, the result hightlight text may vary depend of the content of file.</p>\n<p>e.g. If I query like meth*, the result may include method, methodology, etc.\nI need to know which words are found in the file to use the chunk class.</p>\n<p>Is there a way to find the list of keywords that found for a search result?</p>\n<p>Thanks</p>\n<hr>\n<h3 id=\"junaid\"><a href=\"#junaid\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>junaid</h3>\n<p><em>May 16, 2009 at 12:13 pm</em></p>\n<p>hi andrew,\ni have a problem while using your method code. i have only included exception .php file and Zend/Search folder in my application/libraries. i get an error\nMessage:</p>\n<pre class=\"language-text\"><code class=\"language-text\">CI_Zend::require_once(Zend/Search/Lucene.php) [ci-zend.require-once]: failed to open stream: No such file or directory\n\nFilename: libraries/Zend.php\n\nLine Number: 35</code></pre>\n<p>if u can please help me .</p>\n<hr>\n<h3 id=\"junaid-1\"><a href=\"#junaid-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>junaid</h3>\n<p><em>May 17, 2009 at 4:18 am</em></p>\n<p>hi,\nthanks for your reply.</p>\n<pre class=\"language-text\"><code class=\"language-text\">/system/application/libraries/Zend/Search/Lucene.php does exist.</code></pre>\n<p>i m on windows with XAMPP. i m also using CI 1.71. but i read on codeigniter/forums that u have to write</p>\n<pre class=\"language-text\"><code class=\"language-text\">$this-&gt;load-&gt;library(‘zend’);\n$this-&gt;zend-&gt;load( ‘Zend/Search/Lucene’);</code></pre>\n<p>instead of</p>\n<pre class=\"language-text\"><code class=\"language-text\">$this-&gt;load-&gt;library(‘zend’, ‘Zend/Search/Lucene’);</code></pre>\n<p>in the controller.</p>\n<p>also i have upgraded log_threshold to 4. i have checked the log and classes are successfully initialized and loaded...</p>\n<p>i have changed the reindex function according to my database. i have a “event” table in my DB. and it has a “Event_name” field. so reindex looks like</p>\n<pre class=\"language-text\"><code class=\"language-text\">function reindex()\n{\n    // Create index. Will delete any existing index.\n    $this-&gt;create();\n\n    // Obtain all events.\n    $query = $this-&gt;db-&gt;get(‘event’);\n\n    // Loop through articles, adding an index for each one.\n    foreach ($query-&gt;result() as $event)\n    {\n        // Create Lucene document for this article.\n        $doc = new Zend_Search_Lucene_Document();\n\n        // Add required fields.\n        $doc-&gt;addField(Zend_Search_Lucene_Field::Text(‘eventname’, $event-&gt;Event_name));\n\n        $index-&gt;addDocument($doc);\n\n        echo ‘Added ‘ . $item-&gt;eventname . ‘ to index.\n        ‘;\n    }\n\n    $index-&gt;optimize();\n}</code></pre>\n<p>and i get a long long error</p>\n<pre class=\"language-text\"><code class=\"language-text\">Fatal error: Uncaught exception ‘Zend_Search_Lucene_Exception’ with message ‘Index doesn’t exists in the specified directory.’ in C:xampphtdocscodeignitersystemapplicationlibrariesZendSearchLucene.php:547 Stack trace: #0 C:xampphtdocscodeignitersystemapplicationlibrariesZendSearchLucene.php(214): Zend_Search_Lucene-&gt;__construct(‘C:xampphtdocs…’, false) #1 C:xampphtdocscodeignitersystemapplicationcontrollerssearch.php(70): Zend_Search_Lucene::open(‘C:xampphtdocs…’) #2 C:xampphtdocscodeignitersystemcodeigniterCodeIgniter.php(233): Search-&gt;result() #3 C:xampphtdocscodeigniterindex.php(115): require_once(‘C:xampphtdocs…’) #4 {main} thrown in C:xampphtdocscodeignitersystemapplicationlibrariesZendSearchLucene.php on line 547</code></pre>\n<hr>\n<h3 id=\"andy-1\"><a href=\"#andy-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Andy</h3>\n<p><em>May 17, 2009 at 4:19 am</em></p>\n<p>It looks like an error in my code. I’ve changed the way the library is loaded, as you suggested. Removed the create method, and have created the index directly within the reindex method.</p>\n<hr>\n<h3 id=\"john\"><a href=\"#john\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>john</h3>\n<p><em>May 21, 2009 at 6:51 am</em></p>\n<pre class=\"language-text\"><code class=\"language-text\">A PHP Error was encountered\nSeverity: Notice</code></pre>\n<p>I got this error when i try ur code. i spend few days but i still can’t fix it. please help</p>\n<pre class=\"language-text\"><code class=\"language-text\">Message: iconv_strlen() [function.iconv-strlen]: Wrong charset, conversion from `’ to `UCS-4LE’ is not allowed\n\nFilename: Search/QueryLexer.php\n\nLine Number: 343</code></pre>\n<hr>\n<h3 id=\"andy-2\"><a href=\"#andy-2\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Andy</h3>\n<p><em>May 21, 2009 at 6:55 am</em></p>\n<p>You appear to be having a problem with the Zend library class rather than my code.</p>\n<p>A quick Google brings something that might help.</p>\n<hr>\n<h3 id=\"yeiniel\"><a href=\"#yeiniel\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>yeiniel</h3>\n<p><em>February 10, 2010 at 11:47 am</em></p>\n<p>there is no problem width the code, the problem here is that the search index is not created. you need to create the index first. see Zend framework documentation to acomplish that</p>\n<hr>\n<h3 id=\"noel\"><a href=\"#noel\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>noel</h3>\n<p><em>May 14, 2010 at 4:50 am</em></p>\n<p>This works fine on my local, but as soon as i put it on my live server i get:</p>\n<pre class=\"language-text\"><code class=\"language-text\">A PHP Error was encountered\n\nSeverity: Warning\n\nMessage: CI_Zend::require_once(Zend/Search/Lucene.php) [ci-zend.require-once]: failed to open stream: No such file or directory\n\nFilename: libraries/Zend.php\n\nLine Number: 51</code></pre>\n<hr>\n<h3 id=\"brian\"><a href=\"#brian\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Brian</h3>\n<p><em>January 3, 2011 at 12:58 pm</em></p>\n<p>Thank you, I have the Lucene searching within the CI framework now, but do you know of a way to paginate the results? The CI Library is fine for database queries, but I am not sure how to implement pagination with the Lucene indexes...</p>\n<hr>\n<h3 id=\"tom\"><a href=\"#tom\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>tom</h3>\n<p><em>January 3, 2011 at 12:59 pm</em></p>\n<p>pls help me...</p>\n<pre class=\"language-text\"><code class=\"language-text\">Fatal error: Class ‘Zend_Search_Lucene’ not found</code></pre>\n<hr>\n<h3 id=\"ria\"><a href=\"#ria\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>ria</h3>\n<p><em>March 19, 2011 at 1:54 pm</em></p>\n<p>very helpful resource. thanks for sharing.</p>\n<hr>\n<h3 id=\"annony\"><a href=\"#annony\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>annony</h3>\n<p><em>August 8, 2011 at 9:57 am</em></p>\n<p>Index doesnâ€™t exists in the specified directory::</p>\n<p>I work on windows, and may be its due to file permission. Anyway, I tried using create first and then open . See,\n<a href=\"http://framework.zend.com/manual/1.11/en/learning.lucene.index-opening.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://framework.zend.com/manual/1.11/en/learning.lucene.index-opening.html</a></p>\n<p>Once created , I removed create statement, and worked fine</p>\n<hr>\n<h3 id=\"leonardo-siagian\"><a href=\"#leonardo-siagian\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Leonardo Siagian</h3>\n<p><em>March 10, 2014 at 5:18 am</em></p>\n<p>how if i use category in searching? it’s mean, i select firstly category before searching.</p>\n<p>i try this code:</p>\n<pre class=\"language-text\"><code class=\"language-text\">$category= $this-&gt;input-&gt;post(‘category’);\n$keyword =strtolower($this-&gt;input-&gt;post(‘keyword’));\n\n$query = new Zend_Search_Lucene_Search_Query_MultiTerm();\n$query-&gt;addTerm(new Zend_Search_Lucene_Index_Term($keyword,’content_article’),true);\n$query-&gt;addTerm(new Zend_Search_Lucene_Index_Term($category,category_article’), true);\n$data[‘results’] = $index-&gt;find($query);</code></pre>\n<p>according that code, i just can use single word as the keyword, and can not use(find) more than one word (phrase).</p>\n<p>anybody can solve my problem? thanks ...</p>\n<hr>\n<h3 id=\"kopano-unity\"><a href=\"#kopano-unity\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Kopano Unity</h3>\n<p><em>July 22, 2014 at 1:41 pm</em>\nHi Jeff</p>\n<p>Thanks for the post first of all it is very understandable, but I keep coming across an error in my code hope you can help me here is my stackoverflow question link <a href=\"http://stackoverflow.com/questions/24887645/zend-lucene-search-content-inside-a-datebase-in-html-on-a-live-website-404-er\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://stackoverflow.com/questions/24887645/zend-lucene-search-content-inside-a-datebase-in-html-on-a-live-website-404-er</a></p>\n<hr>\n","cover_image":null}},"context":{}}