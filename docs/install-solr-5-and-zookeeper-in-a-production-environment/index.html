<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Install Solr 5 and Zookeeper in a production environment - Andrew Rowland</title><meta name="gridsome:hash" content="3abed4817c87332b7256cc04f5102649b2af0839"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.12"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="I only want to help you"><meta data-vue-tag="ssr" name="description" content="Recently I had to set up three Solr servers in an AWS environment. I couldn’t find anything specific to help me, so had to locate all the information separately. Hopefully the following may be of use to anyone who has to go through the same. In my situation, I have 3 servers that will sit behind a load balancer. The following describes how I set up each server."><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/assets/css/0.styles.9b360e90.css" as="style"><link rel="preload" href="/assets/js/app.889edf6a.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.0a3a8d46.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.7fd9cfd2.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.ee987fdf.js"><link rel="prefetch" href="/assets/js/page--src--templates--tag-vue.64b20420.js"><link rel="stylesheet" href="/assets/css/0.styles.9b360e90.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <script>
      // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
      (function() {
        window.__onThemeChange = function() {};
        function setTheme(newTheme) {
          window.__theme = newTheme;
          preferredTheme = newTheme;
          document.body.setAttribute('data-theme', newTheme);
          window.__onThemeChange(newTheme);
        }

        var preferredTheme;
        try {
          preferredTheme = localStorage.getItem('theme');
        } catch (err) { }

        window.__setPreferredTheme = function(newTheme) {
          setTheme(newTheme);
          try {
            localStorage.setItem('theme', newTheme);
          } catch (err) {}
        }

        var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkQuery.addListener(function(e) {
          window.__setPreferredTheme(e.matches ? 'dark' : 'light')
        });

        setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
      })();
    </script>

    <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/" class="logo active"><span class="logo__text">
    ← Andrew Rowland
  </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">
      Install Solr 5 and Zookeeper in a production environment
    </h1><div class="post-meta">
   Posted 4. June 2015.
   <strong>6 min read.</strong></div></div><div class="post content-box"><div class="post__header"><!----></div><div class="post__content"><p>Recently I had to set up three Solr servers in an AWS environment. I couldn’t find anything specific to help me, so had to locate all the information separately. Hopefully the following may be of use to anyone who has to go through the same. In my situation, I have 3 servers that will sit behind a load balancer. The following describes how I set up each server.</p>
<p>Initially I thought it best to update all packages on each Amazon Linux AMI. I was using a green field environment. You might not be in that situation, so may not want to do the following.</p>
<pre class="language-text"><code class="language-text">sudo yum clean all
sudo yum update</code></pre>
<p>Solr 5 requires a newer version of Java that was pre-installed on the server. So we need to obtained an updated Java package, and select it as the default version.</p>
<pre class="language-text"><code class="language-text">sudo yum install java-1.7.0-openjdk
sudo alternatives --config java</code></pre>
<p>Now we need to obtain a Solr package. You can find a mirror here: <a href="http://lucene.apache.org/solr/mirrors-solr-latest-redir.html" target="_blank" rel="nofollow noopener noreferrer">http://lucene.apache.org/solr/mirrors-solr-latest-redir.html</a>. For example, I downloaded an archive using:</p>
<pre class="language-text"><code class="language-text">wget http://mirror.catn.com/pub/apache/lucene/solr/5.1.0/solr-5.1.0.tgz</code></pre>
<p>Let’s make certain all the pre-requisites exist to run Solr, but decompressing the archive, and running it.</p>
<pre class="language-text"><code class="language-text">tar zxf solr-5.1.0.tgz
cd solr-5.1.0
bin/solr start
bin/solr status</code></pre>
<p>If Solr looks like it is running correctly, let’s stop it.</p>
<pre class="language-text"><code class="language-text">bin/solr stop</code></pre>
<p>We can now install it using the pre-packaged service install script that comes with the archive. Exit the Solr folder, and extract the service install script.</p>
<pre class="language-text"><code class="language-text">cd ..
tar xzf solr-5.1.0.tgz solr-5.1.0/bin/install_solr_service.sh --strip-components=2</code></pre>
<p>Using this script we can install the service.</p>
<pre class="language-text"><code class="language-text">sudo bash ./install_solr_service.sh solr-5.1.0.tgz</code></pre>
<p>The script will install Solr into /opt/solr-5.1.0, with a symbolic link from /opt/solr. All writable files (i.e. logs) are placed in /opt/solr. The service runs under the user ‘solr’, that will be created for this purpose. Check the service is running correctly.</p>
<pre class="language-text"><code class="language-text">sudo service solr status</code></pre>
<p>Just to note, by default the Java heap size is 512M. This will more than likely need to be increased in a production environment. What this value will be will depend on your requirements, and is beyond the scope of this post. If you do need to amend this value, use an editor such as Vi to edit the following file:</p>
<pre class="language-text"><code class="language-text">sudo vi /var/solr/solr.in.sh</code></pre>
<p>The specific value you will need to change is SOLR_JAVA_MEM. Restart the service to make certain the new configuration is picked up.</p>
<p>You should now be able to access the Solr admin site on the server. By default this runs on port 8983, for example:</p>
<p><a href="http://your-server:8983/solr/" target="_blank" rel="nofollow noopener noreferrer">http://your-server:8983/solr/</a></p>
<p>Now Solr is up and running we need to set up Zookeeper. Zookeeper is used to maintain the configuration between the three Solr servers.</p>
<p>Once again we need to obtain a package from a Zookeeper mirror.</p>
<pre class="language-text"><code class="language-text">get http://mirror.vorboss.net/apache/zookeeper/current/zookeeper-3.4.6.tar.gz</code></pre>
<p>Zookeeper does not come with a nice service installer, so we need to manually set this up. First extract into /opt.</p>
<pre class="language-text"><code class="language-text">sudo tar xzxf zookeeper-3.4.6.tar.gz -C /opt</code></pre>
<p>Create a symbolic link. This is for ease of upgrading.</p>
<pre class="language-text"><code class="language-text">sudo ln -s /opt/zookeeper-3.4.6/ /opt/zookeeper</code></pre>
<p>Rename the example Zookeeper config file.</p>
<pre class="language-text"><code class="language-text">sudo mv /opt/zookeeper/conf/zoo_sample.cfg /opt/zookeeper/conf/zoo.cfg</code></pre>
<p>You will need to add something like the following to zoo.cfg. These lines list all servers that need to be maintained by Zookeeper. Amend with applicable server IP addresses.</p>
<pre class="language-text"><code class="language-text">server.1=serverip1:2888:3888
server.2=serverip2:2888:3888
server.3=serverip3:2888:3888</code></pre>
<p>Whilst editing this file, change the data directory:</p>
<pre class="language-text"><code class="language-text">dataDir=/var/lib/zookeeper/data</code></pre>
<p>Each server requires a context file called ‘myid’. This is used to identify it.</p>
<pre class="language-text"><code class="language-text">sudo mkdir /var/lib/zookeeper
sudo mkdir /var/lib/zookeeper/data
sudo touch /var/lib/zookeeper/data/myid</code></pre>
<p>Edit each myid file and add the appropriate number for each server. For example, for three servers this will be 1, 2 or 3.</p>
<p>Now start up each ZooKeeper server:</p>
<pre class="language-text"><code class="language-text">sudo /opt/zookeeper/bin/zkServer.sh start</code></pre>
<p>We need to return to Solr, to configure the Zookeeper hosts. Edit the solr.xml file::</p>
<p>sudo vi /var/solr/data/solr.xml</p>
<p>Within the solrcloud element add the following, once again amending with your server IP addresses:</p>
<pre class="language-text"><code class="language-text">serverip1:2181,serverip2:2182,serverip3:2183</code></pre>
<p>It should look something like the following:</p>
<pre class="language-text"><code class="language-text">&lt;solr&gt;
  &lt;solrcloud&gt;
    ...
    &lt;str name=&quot;zkHost&quot;&gt;serverip1:2181,serverip2:2182,serverip3:2183&lt;/str&gt;
  &lt;/solrcloud&gt;
&lt;/solr&gt;</code></pre>
<p>Restart Solr on all servers managed by Zookeeper:</p>
<pre class="language-text"><code class="language-text">sudo service solr restart</code></pre>
<p>We can check Solr is connected to Zookeeper, by obtaining its status.</p>
<pre class="language-text"><code class="language-text">sudo service solr status</code></pre>
<p>There should be some additional JSON in the response returned:</p>
<pre class="language-text"><code class="language-text">&quot;cloud&quot;:{
    &quot;ZooKeeper&quot;:&quot;serverip1:2181,serverip2:2182,serverip3:2183&quot;,
    &quot;liveNodes&quot;:&quot;3&quot;,
    &quot;collections&quot;:&quot;0&amp;&quot;
}</code></pre>
<p>Now everything is working correct, we should create a start up script for Zookeeper. We are going to customise the zkServer.sh script. First copy to the start up scripts:</p>
<pre class="language-text"><code class="language-text">sudo cp /opt/zookeeper/bin/zkServer.sh /etc/init.d/zookeeper</code></pre>
<p>Edit the copied file to include the following start up comment:</p>
<pre class="language-text"><code class="language-text"># chkconfig: - 20 80
# description: starts zookeeper - /opt/zookeeper under user root</code></pre>
<p>I also amended the path to the bin directory. Locate and edit the following in the script:</p>
<pre class="language-text"><code class="language-text">ZOOBIN=/opt/zookeeper/bin</code></pre>
<p>Now we can add the start up script, and switch it on:</p>
<pre class="language-text"><code class="language-text">sudo chkconfig --add /etc/init.d/zookeeper
sudo chkconfig --level 2345 zookeeper on</code></pre>
<p>These will give it the same start options as Solr.</p>
<p>This should have Solr, and Zookeeper set up and installed on all three servers. You may have more servers if your requirements are more extensive. Bear in mind, Zookeeper requires an odd number of servers to function.</p>
<p>As an addition to the post, we can now add a collection, and test that it is replicated across our Solr servers. I copied collection configuration from our development environment into the home directory of the user I managed the Solr servers with. I could then use this configuration to create my new collection.</p>
<p>So to create a new collection, reference the uploaded collection configuration, so that it is stored in Zookeeper:</p>
<pre class="language-text"><code class="language-text">sudo /opt/solr/bin/solr create_collection -c collection-qa -d ~/collection-dev/conf -n collection-qa -shards 1 -replicationFactor 3</code></pre>
<p>This created a collection called ‘collection-qa’, from the configuration I had uploaded into the ~/collection-dev/conf folder. For my purposes a wanted one shard, replicated over all three Solr servers.</p>
<p>If you need to remove a collection use can use the following:</p>
<pre class="language-text"><code class="language-text">sudo /opt/solr/bin/solr delete -c collection-qa</code></pre>
<p>All collection configuration files are now in Zookeeper. If you want to update this configuration, and not delete the how collection, you’ll need to use the Solr version of the Zookeeper CLI. It can be sound here:</p>
<pre class="language-text"><code class="language-text">sudo /opt/solr/server/scripts/cloud-scripts/zkcli.sh</code></pre>
<p>For example, to view the collection schema stored in Zookeeper, use:</p>
<pre class="language-text"><code class="language-text">sudo /opt/solr/server/scripts/cloud-scripts/zkcli.sh -zkhost localhost:2181 -cmd get /configs/collection-qa/schema.xml</code></pre>
<p>To upload an amended schema file to Zookeeper use:</p>
<pre class="language-text"><code class="language-text">sudo /opt/solr/server/scripts/cloud-scripts/zkcli.sh -zkhost localhost:2181 -cmd putfile /configs/collection-qa/schema.xml collection-dev/conf/schema.xml</code></pre>
<p>I’ve used the example file names, and locations as explained previously. You’ll need to amend for your purposes.</p>
<p>If you do update the document schema you will need to reload a core using something like Curl to do the following:</p>
<pre class="language-text"><code class="language-text">sudo curl http://localhost:8983/solr/admin/cores?action=RELOAD\&amp;amp;amp;amp;amp;amp;amp;core=collection-qa_shard1_replica3</code></pre>
<p>I hope this has been useful, but appreciate that I might not be too clear on some instructions. If you need me to clarify anything, give us a shout.</p>
</div><div class="post__footer"><div class="post-tags"><a href="/tag/Linux/" class="post-tags__link"><span>#</span> Linux
		</a><a href="/tag/Solr/" class="post-tags__link"><span>#</span> Solr
		</a></div></div></div><div class="post-comments"></div><div class="author post-author"><img alt="Author image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-79abe12977319e63670ceacd51dd8a4b'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='5'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-79abe12977319e63670ceacd51dd8a4b)' width='180' height='180' xlink:href='data:image/png%3bbase64%2c/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABAAEADASIAAhEBAxEB/8QAGwAAAgMBAQEAAAAAAAAAAAAABgcDBAUCAAj/xAA2EAACAQMCBAUCBAMJAAAAAAABAgMABBEFEgYhMUETFCJRYYGRMkJxsRUjQwckUlOSocHh8P/EABoBAAIDAQEAAAAAAAAAAAAAAAMEAgUGAQD/xAAiEQACAgIDAAMAAwAAAAAAAAABAgADBBESITETMkFRUmH/2gAMAwEAAhEDEQA/AK0Gpp3NaMGpxcvWKR68V3I6Qp/qNSpxbddoo/uavzwP7ALYB%2bR8w6pD3kFXodVg/wAYpDWPEep3MgWKKIfJzyogtLe8uWDXVxOT7KxVR9BSeRdVV6Y9jVtd9Vjmi1iAf1BVuPWbYdZBSgNtd2mXinmIx%2bFiSP8AesDUtf1mylCtJHsb8LbP%2b%2btQpau/6mEuU0dsvU%2bh01q2/wAwVMuvWg/qCvmccUay6H%2b8IueWQnSoBrusH8Wo3GfYAUU4v%2bwIyk/rBKKEsnpjYnufDNTrbkc/V9gKopMXX8bL7hTit7gSxsrniexj1CHxoHYqUfmuSDgkVNrAiltb1EUTkwXfsJ%2bDbBXXcycyM02dC0qIwjCBnIoJ/ggs%2bJzbWlzLbWpIYQx4KOh5cs9OnaiTUJNZEiraDytui8goyzcuWc1mb7BY/In2X9G604gTensU2srQ4YdsUvOPrCNdLmfZtKMrAgc%2buDWrqvE/EECmOOO0kgEiQtO6sHBI9RA6EDkP1oY1u%2b1K70uSC6hQO7D%2bbk8hnJPM47UfDYrapncluVTAwQTwWwi5L%2bzEZ/erHlpw%2bFs5Xj6DPpyf1zUwRlRWDAY6kSxjNeW%2b3QSALNKg6%2bE4Uj26jn9K1Psz2tezDjt4nw0YAI7bQR96ns7g2s8UsLL40TB1b5FCFlqTxPi43PH3OeYol0K5OoNMI7Vo4EGQ5Oct7UuuTTYP4kSjodiMnRtcudZ16zlvIoIp1UACEnaBnPPPemv56J7X1Ebscl6/ekrpkvlLvzcrB2ib%2bYoAHowOYpk6XMLiziEZVnUblBOdw%2bcfFZjLTi/XQl5hXc17Pc4vPBigm8zHJI7qGQgct3sR2FDP9oUlv/AUtlIUzsuWRc47mjDiK6tptOeKOwkgutuPFjnYqnzg0s9X1Q39wDbBPBjyqFsnce7f%2b9qYwKi1y78ELmWlaiP0wesNLVAQqM2fzFcCr1rowLEyTMqkcwMYNT%2bcnGAQucflWozqUgk27JmPydo%2b1an5UUdSgCExfaPw1dX6iSQeBD2Zhlj%2bgpkaTYxwaawRRE0C7ACM8uh5fQHPzU6afJGztEq7ipySG6fBB5dv2qNFaORAno3rtdeqnqcN8nlVGAF8k2JaSW8ckURmhZjOhO/aCwIJ5ZPatXh7WBYTvJtZ7V2ICJgNH7deo%2bKpRlUjaOEgq4AZtp6g5OfrgCqF1blpJH2oi4VmELkdu/vzHfpQ7EFg0Z2p2rbawm4s4kgm02ZLWO5FwQUI8NgFz3JpaXV1Laadb4O4lih5de/X61rh5JDcDxnV4xuYE8zyzn9qw%2bIIvN27ywJKu3JTxGyygdj2yftXqKxUdrGbLzaumE9BrLbQuNo6DHLFcX1%2b7gEy%2b4wTQ5FeBgBIeZ/MB/xXE1xzG71D4pv5eoKf/9k=' /%3e%3c/svg%3e" width="180" data-src="/assets/static/author.e6b6009.01fea4a6eb109fed65874b88d6ddc592.png" data-srcset="/assets/static/author.e6b6009.01fea4a6eb109fed65874b88d6ddc592.png 180w" data-sizes="(max-width: 180px) 100vw, 180px" class="author__image g-image g-image--lazy g-image--loading"><noscript><img src="/assets/static/author.e6b6009.01fea4a6eb109fed65874b88d6ddc592.png" class="author__image g-image g-image--loaded" width="180" alt="Author image"></noscript><!----><p class="author__intro">
		I only want to help you...
	</p><p class="author__links"><a href="//www.linkedin.com/in/hashbang/">LinkedIn</a><a href="//twitter.com/andyjrowland">Twitter</a><a href="//github.com/ajrowland">GitHub</a></p></div></main><footer class="footer"><span class="footer__copyright">Copyright © 2019. </span><span class="footer__links"></span></footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"Install Solr 5 and Zookeeper in a production environment","path":"\u002Finstall-solr-5-and-zookeeper-in-a-production-environment\u002F","date":"4. June 2015","timeToRead":6,"tags":[{"id":"Linux","title":"Linux","path":"\u002Ftag\u002FLinux\u002F"},{"id":"Solr","title":"Solr","path":"\u002Ftag\u002FSolr\u002F"}],"description":"Recently I had to set up three Solr servers in an AWS environment. I couldn’t find anything specific to help me, so had to locate all the information separately. Hopefully the following may be of use to anyone who has to go through the same. In my situation, I have 3 servers that will sit behind a load balancer. The following describes how I set up each server.","content":"\u003Cp\u003ERecently I had to set up three Solr servers in an AWS environment. I couldn’t find anything specific to help me, so had to locate all the information separately. Hopefully the following may be of use to anyone who has to go through the same. In my situation, I have 3 servers that will sit behind a load balancer. The following describes how I set up each server.\u003C\u002Fp\u003E\n\u003Cp\u003EInitially I thought it best to update all packages on each Amazon Linux AMI. I was using a green field environment. You might not be in that situation, so may not want to do the following.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo yum clean all\nsudo yum update\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ESolr 5 requires a newer version of Java that was pre-installed on the server. So we need to obtained an updated Java package, and select it as the default version.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo yum install java-1.7.0-openjdk\nsudo alternatives --config java\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENow we need to obtain a Solr package. You can find a mirror here: \u003Ca href=\"http:\u002F\u002Flucene.apache.org\u002Fsolr\u002Fmirrors-solr-latest-redir.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Ehttp:\u002F\u002Flucene.apache.org\u002Fsolr\u002Fmirrors-solr-latest-redir.html\u003C\u002Fa\u003E. For example, I downloaded an archive using:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ewget http:\u002F\u002Fmirror.catn.com\u002Fpub\u002Fapache\u002Flucene\u002Fsolr\u002F5.1.0\u002Fsolr-5.1.0.tgz\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ELet’s make certain all the pre-requisites exist to run Solr, but decompressing the archive, and running it.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Etar zxf solr-5.1.0.tgz\ncd solr-5.1.0\nbin\u002Fsolr start\nbin\u002Fsolr status\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EIf Solr looks like it is running correctly, let’s stop it.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ebin\u002Fsolr stop\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EWe can now install it using the pre-packaged service install script that comes with the archive. Exit the Solr folder, and extract the service install script.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ecd ..\ntar xzf solr-5.1.0.tgz solr-5.1.0\u002Fbin\u002Finstall_solr_service.sh --strip-components=2\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EUsing this script we can install the service.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo bash .\u002Finstall_solr_service.sh solr-5.1.0.tgz\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe script will install Solr into \u002Fopt\u002Fsolr-5.1.0, with a symbolic link from \u002Fopt\u002Fsolr. All writable files (i.e. logs) are placed in \u002Fopt\u002Fsolr. The service runs under the user ‘solr’, that will be created for this purpose. Check the service is running correctly.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo service solr status\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EJust to note, by default the Java heap size is 512M. This will more than likely need to be increased in a production environment. What this value will be will depend on your requirements, and is beyond the scope of this post. If you do need to amend this value, use an editor such as Vi to edit the following file:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo vi \u002Fvar\u002Fsolr\u002Fsolr.in.sh\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe specific value you will need to change is SOLR_JAVA_MEM. Restart the service to make certain the new configuration is picked up.\u003C\u002Fp\u003E\n\u003Cp\u003EYou should now be able to access the Solr admin site on the server. By default this runs on port 8983, for example:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"http:\u002F\u002Fyour-server:8983\u002Fsolr\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Ehttp:\u002F\u002Fyour-server:8983\u002Fsolr\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003ENow Solr is up and running we need to set up Zookeeper. Zookeeper is used to maintain the configuration between the three Solr servers.\u003C\u002Fp\u003E\n\u003Cp\u003EOnce again we need to obtain a package from a Zookeeper mirror.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Eget http:\u002F\u002Fmirror.vorboss.net\u002Fapache\u002Fzookeeper\u002Fcurrent\u002Fzookeeper-3.4.6.tar.gz\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EZookeeper does not come with a nice service installer, so we need to manually set this up. First extract into \u002Fopt.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo tar xzxf zookeeper-3.4.6.tar.gz -C \u002Fopt\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ECreate a symbolic link. This is for ease of upgrading.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo ln -s \u002Fopt\u002Fzookeeper-3.4.6\u002F \u002Fopt\u002Fzookeeper\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ERename the example Zookeeper config file.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo mv \u002Fopt\u002Fzookeeper\u002Fconf\u002Fzoo_sample.cfg \u002Fopt\u002Fzookeeper\u002Fconf\u002Fzoo.cfg\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EYou will need to add something like the following to zoo.cfg. These lines list all servers that need to be maintained by Zookeeper. Amend with applicable server IP addresses.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Eserver.1=serverip1:2888:3888\nserver.2=serverip2:2888:3888\nserver.3=serverip3:2888:3888\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EWhilst editing this file, change the data directory:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003EdataDir=\u002Fvar\u002Flib\u002Fzookeeper\u002Fdata\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEach server requires a context file called ‘myid’. This is used to identify it.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo mkdir \u002Fvar\u002Flib\u002Fzookeeper\nsudo mkdir \u002Fvar\u002Flib\u002Fzookeeper\u002Fdata\nsudo touch \u002Fvar\u002Flib\u002Fzookeeper\u002Fdata\u002Fmyid\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEdit each myid file and add the appropriate number for each server. For example, for three servers this will be 1, 2 or 3.\u003C\u002Fp\u003E\n\u003Cp\u003ENow start up each ZooKeeper server:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo \u002Fopt\u002Fzookeeper\u002Fbin\u002FzkServer.sh start\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EWe need to return to Solr, to configure the Zookeeper hosts. Edit the solr.xml file::\u003C\u002Fp\u003E\n\u003Cp\u003Esudo vi \u002Fvar\u002Fsolr\u002Fdata\u002Fsolr.xml\u003C\u002Fp\u003E\n\u003Cp\u003EWithin the solrcloud element add the following, once again amending with your server IP addresses:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Eserverip1:2181,serverip2:2182,serverip3:2183\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EIt should look something like the following:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E&lt;solr&gt;\n  &lt;solrcloud&gt;\n    ...\n    &lt;str name=&quot;zkHost&quot;&gt;serverip1:2181,serverip2:2182,serverip3:2183&lt;\u002Fstr&gt;\n  &lt;\u002Fsolrcloud&gt;\n&lt;\u002Fsolr&gt;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ERestart Solr on all servers managed by Zookeeper:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo service solr restart\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EWe can check Solr is connected to Zookeeper, by obtaining its status.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo service solr status\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThere should be some additional JSON in the response returned:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E&quot;cloud&quot;:{\n    &quot;ZooKeeper&quot;:&quot;serverip1:2181,serverip2:2182,serverip3:2183&quot;,\n    &quot;liveNodes&quot;:&quot;3&quot;,\n    &quot;collections&quot;:&quot;0&amp;&quot;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENow everything is working correct, we should create a start up script for Zookeeper. We are going to customise the zkServer.sh script. First copy to the start up scripts:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo cp \u002Fopt\u002Fzookeeper\u002Fbin\u002FzkServer.sh \u002Fetc\u002Finit.d\u002Fzookeeper\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEdit the copied file to include the following start up comment:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E# chkconfig: - 20 80\n# description: starts zookeeper - \u002Fopt\u002Fzookeeper under user root\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EI also amended the path to the bin directory. Locate and edit the following in the script:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003EZOOBIN=\u002Fopt\u002Fzookeeper\u002Fbin\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENow we can add the start up script, and switch it on:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo chkconfig --add \u002Fetc\u002Finit.d\u002Fzookeeper\nsudo chkconfig --level 2345 zookeeper on\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThese will give it the same start options as Solr.\u003C\u002Fp\u003E\n\u003Cp\u003EThis should have Solr, and Zookeeper set up and installed on all three servers. You may have more servers if your requirements are more extensive. Bear in mind, Zookeeper requires an odd number of servers to function.\u003C\u002Fp\u003E\n\u003Cp\u003EAs an addition to the post, we can now add a collection, and test that it is replicated across our Solr servers. I copied collection configuration from our development environment into the home directory of the user I managed the Solr servers with. I could then use this configuration to create my new collection.\u003C\u002Fp\u003E\n\u003Cp\u003ESo to create a new collection, reference the uploaded collection configuration, so that it is stored in Zookeeper:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo \u002Fopt\u002Fsolr\u002Fbin\u002Fsolr create_collection -c collection-qa -d ~\u002Fcollection-dev\u002Fconf -n collection-qa -shards 1 -replicationFactor 3\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThis created a collection called ‘collection-qa’, from the configuration I had uploaded into the ~\u002Fcollection-dev\u002Fconf folder. For my purposes a wanted one shard, replicated over all three Solr servers.\u003C\u002Fp\u003E\n\u003Cp\u003EIf you need to remove a collection use can use the following:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo \u002Fopt\u002Fsolr\u002Fbin\u002Fsolr delete -c collection-qa\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EAll collection configuration files are now in Zookeeper. If you want to update this configuration, and not delete the how collection, you’ll need to use the Solr version of the Zookeeper CLI. It can be sound here:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo \u002Fopt\u002Fsolr\u002Fserver\u002Fscripts\u002Fcloud-scripts\u002Fzkcli.sh\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EFor example, to view the collection schema stored in Zookeeper, use:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo \u002Fopt\u002Fsolr\u002Fserver\u002Fscripts\u002Fcloud-scripts\u002Fzkcli.sh -zkhost localhost:2181 -cmd get \u002Fconfigs\u002Fcollection-qa\u002Fschema.xml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ETo upload an amended schema file to Zookeeper use:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo \u002Fopt\u002Fsolr\u002Fserver\u002Fscripts\u002Fcloud-scripts\u002Fzkcli.sh -zkhost localhost:2181 -cmd putfile \u002Fconfigs\u002Fcollection-qa\u002Fschema.xml collection-dev\u002Fconf\u002Fschema.xml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EI’ve used the example file names, and locations as explained previously. You’ll need to amend for your purposes.\u003C\u002Fp\u003E\n\u003Cp\u003EIf you do update the document schema you will need to reload a core using something like Curl to do the following:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Esudo curl http:\u002F\u002Flocalhost:8983\u002Fsolr\u002Fadmin\u002Fcores?action=RELOAD\\&amp;amp;amp;amp;amp;amp;amp;core=collection-qa_shard1_replica3\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EI hope this has been useful, but appreciate that I might not be too clear on some instructions. If you need me to clarify anything, give us a shout.\u003C\u002Fp\u003E\n","cover_image":null}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.889edf6a.js" defer></script><script src="/assets/js/page--src--templates--post-vue.0a3a8d46.js" defer></script>
  </body>
</html>